# GraphQL Integration –¥–ª—è ZakupAI

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GraphQL v2 API –ì–æ—Å–∑–∞–∫—É–ø–æ–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (¬´–ª–∞–∫¬ª, ¬´—É–≥–æ–ª—å¬ª, ¬´–º–µ–±–µ–ª—å¬ª –∏ —Ç.–¥.) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback –Ω–∞ REST v3 API.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **GraphQL –º–æ–¥—É–ª—å** (`bot/goszakup_graphql.py`)

- ‚úÖ –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ GraphQL v2 API
- ‚úÖ –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π introspection —Å—Ö–µ–º–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ REST v3
- ‚úÖ –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å** (`bot/services.py`)

- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GraphQL –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π GoszakupService
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 3. **N8N Workflows**

- ‚úÖ `zakupai_workflow_fixed.json` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π workflow
- ‚úÖ `zakupai_workflow_enhanced.json` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å fallback
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ GraphQL –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ö–µ–º—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 4. **–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç** (`test_graphql_search.py`)

- ‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π API
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ GraphQL vs REST
- ‚úÖ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üîç –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–∏—Å–∫

### GraphQL v2 (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):

```graphql
query SearchLots($filter: LotsFiltersInput) {
  Lots(filter: $filter) {
    lotNumber
    nameRu
    descriptionRu
    amount
    count
    customerNameRu
    TrdBuy {
      nameRu
      numberAnno
      RefTradeMethods { nameRu }
    }
    RefLotsStatus { nameRu }
  }
}
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```json
{
  "filter": {
    "nameRu": "–ª–∞–∫",
    "nameDescriptionRu": "–ª–∞–∫"
  }
}
```

### REST v3 (fallback):

```
GET https://ows.goszakup.gov.kz/v3/lots?nameRu=–ª–∞–∫&descriptionRu=–ª–∞–∫&limit=10
```

## ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
export GOSZAKUP_TOKEN="–≤–∞—à_—Ç–æ–∫–µ–Ω_api"
```

### 2. –î–ª—è N8N workflow:

```json
{
  "name": "Authorization",
  "value": "Bearer {{$env.GOSZAKUP_TOKEN}}"
}
```

### 3. –î–ª—è Python –∫–æ–¥–∞:

```python
from bot.goszakup_graphql import GoszakupGraphQLClient, format_search_results

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
client = GoszakupGraphQLClient(token='your_token')

# –ü–æ–∏—Å–∫ —Å GraphQL + fallback
results = await client.search_lots('–ª–∞–∫', limit=10)
formatted = format_search_results(results)
```

## üîß API Reference

### `GoszakupGraphQLClient`

#### `__init__(token: str, timeout: int = 30)`

- `token`: Bearer —Ç–æ–∫–µ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `timeout`: –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

#### `async search_lots(keyword: str, limit: int = 10, use_graphql: bool = True, filters: Optional[Dict] = None) -> List[SearchResult]`

- `keyword`: –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞
- `limit`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `use_graphql`: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GraphQL (True) –∏–ª–∏ —Å—Ä–∞–∑—É REST (False)
- `filters`: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è GraphQL

#### `format_search_results(results: List[SearchResult]) -> str`

–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∏—Ç–∞–µ–º–æ–º –≤–∏–¥–µ.

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤—É "–ª–∞–∫":

```python
results = await client.search_lots("–ª–∞–∫", limit=5)
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:

```python
filters = {
    "nameRu": "–ª–∞–∫",
    "nameDescriptionRu": "–∫—Ä–∞—Å–∫–∞",
    "customerId": 12345
}
results = await client.search_lots("–ª–∞–∫", filters=filters)
```

### –¢–æ–ª—å–∫–æ REST (–±–µ–∑ GraphQL):

```python
results = await client.search_lots("–ª–∞–∫", use_graphql=False)
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞

–ö–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:

- üìù –ù–æ–º–µ—Ä –ª–æ—Ç–∞
- üìã –ù–æ–º–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è
- üì¶ –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
- üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º–∞
- üè¢ –ó–∞–∫–∞–∑—á–∏–∫ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –ë–ò–ù)
- üõí –°–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏
- üìå –°—Ç–∞—Ç—É—Å –ª–æ—Ç–∞

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ GraphQL v2

‚úÖ **–ì–∏–±–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ `LotsFiltersInput`
‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫** - —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
‚úÖ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - TrdBuy, —Å—Ç–∞—Ç—É—Å—ã, –º–µ—Ç–æ–¥—ã –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - —Å—Ç—Ä–æ–≥–∏–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - fallback –Ω–∞ REST –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## üîÑ Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

1. **–û—Å–Ω–æ–≤–Ω–æ–π**: GraphQL v2 API
1. **–ü—Ä–∏ –æ—à–∏–±–∫–µ GraphQL**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ REST v3
1. **–ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ —Ç–æ–∫–µ–Ω–∞**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ REST
1. **–ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ**: –ø–æ–≤—Ç–æ—Ä —Å REST API

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

- –£—Å–ø–µ—à–Ω—ã–µ GraphQL –∑–∞–ø—Ä–æ—Å—ã
- Fallback –Ω–∞ REST API
- –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –¢–∞–π–º–∞—É—Ç—ã –∏ —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–ø—Ä–æ—Å–æ–≤)
python3 test_graphql_search.py

# –ó–∞–ø—É—Å–∫ —Å —Ç–æ–∫–µ–Ω–æ–º (–∂–∏–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
export GOSZAKUP_TOKEN="your_token"
python3 test_graphql_search.py
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–±—Ñ—É—Å–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö
- ‚úÖ SSL/TLS –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ GraphQL vs REST –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ª–æ—Ç—ã / –∑–∞–ø—Ä–æ—Å)

______________________________________________________________________

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã. Telegram –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GraphQL v2 –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∏ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞.

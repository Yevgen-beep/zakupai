From 6e5b9bb4d1c9f5d1db517a826ffba7d5cc3f6c68 Mon Sep 17 00:00:00 2001
From: Codex <codex@example.com>
Date: Tue, 7 Jan 2025 12:00:00 +0300
Subject: [PATCH] fix(build): add additional_contexts for shared libs and update Dockerfile COPY

---
 docker-compose.yml                | 22 ++++++++++++++++++++--
 services/gateway/Dockerfile       |  3 ++-
 services/etl-service/Dockerfile   |  2 ++
 services/risk-engine/Dockerfile   |  2 ++
 services/calc-service/Dockerfile  |  2 ++
 services/embedding-api/Dockerfile |  2 ++
 bot/Dockerfile                    |  2 ++
 services/goszakup-api/Dockerfile  |  2 ++
 services/doc-service/Dockerfile   |  2 ++
 9 files changed, 36 insertions(+), 3 deletions(-)

diff --git a/docker-compose.yml b/docker-compose.yml
index 44a0021..08d4343 100644
--- a/docker-compose.yml
+++ b/docker-compose.yml
@@ -25,6 +25,8 @@
   embedding-api:
     build:
       context: ./services/embedding-api
+      additional_contexts:
+        - libs=./libs
       args:
         - TAG=${TAG:-stage5}
     image: zakupai/embedding-api:${TAG:-stage5}
@@ -45,6 +47,8 @@
   calc-service:
     build:
       context: ./services/calc-service
+      additional_contexts:
+        - libs=./libs
       args:
         - TAG=${TAG:-stage5}
     image: zakupai/calc-service:${TAG:-stage5}
@@ -63,6 +67,8 @@
   risk-engine:
     build:
       context: ./services/risk-engine
+      additional_contexts:
+        - libs=./libs
       args:
         - TAG=${TAG:-stage5}
     image: zakupai/risk-engine:${TAG:-stage5}
@@ -84,7 +90,10 @@
     restart: unless-stopped

   doc-service:
-    build: ./services/doc-service
+    build:
+      context: ./services/doc-service
+      additional_contexts:
+        - libs=./libs
     container_name: zakupai-doc-service
     ports:
       - "7003:8000"
@@ -115,7 +124,10 @@
     restart: unless-stopped

   goszakup-api:
-    build: ./services/goszakup-api
+    build:
+      context: ./services/goszakup-api
+      additional_contexts:
+        - libs=./libs
     container_name: zakupai-goszakup-api
     ports:
       - "7005:8001"
@@ -142,6 +154,8 @@
   etl-service:
     build:
       context: ./services/etl-service
+      additional_contexts:
+        - libs=./libs
       args:
         - TAG=${TAG:-stage5}
     image: zakupai/etl-service:${TAG:-stage5}
@@ -163,6 +177,8 @@
   gateway:
     build:
       context: ./services/gateway
+      additional_contexts:
+        - libs=./libs
       args:
         - TAG=${TAG:-stage5}
     image: zakupai/gateway:${TAG:-stage5}
@@ -256,6 +272,8 @@
   zakupai-bot:
     build:
       context: ./bot
+      additional_contexts:
+        - libs=./libs
       args:
         - TAG=${TAG:-stage5}
     image: zakupai/bot:${TAG:-stage5}

diff --git a/services/gateway/Dockerfile b/services/gateway/Dockerfile
index 05e8da0..9330f90 100644
--- a/services/gateway/Dockerfile
+++ b/services/gateway/Dockerfile
@@ -10,7 +10,8 @@ RUN pip install --no-cache-dir -r /app/requirements.txt

 COPY . /app
-COPY libs/zakupai_common /app/libs/zakupai_common
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common
 RUN pip install /app/libs/zakupai_common

 CMD ["python", "main.py"]

diff --git a/services/etl-service/Dockerfile b/services/etl-service/Dockerfile
index 024c936..a86a85e 100644
--- a/services/etl-service/Dockerfile
+++ b/services/etl-service/Dockerfile
@@ -23,6 +23,8 @@

 # Copy application code
 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common

 # Create directory for logs
 RUN mkdir -p /app/logs

diff --git a/services/risk-engine/Dockerfile b/services/risk-engine/Dockerfile
index f97f71c..de328d4 100644
--- a/services/risk-engine/Dockerfile
+++ b/services/risk-engine/Dockerfile
@@ -10,6 +10,8 @@ RUN pip install --no-cache-dir -r requirements.txt

 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common
 # Стандартный порт внутри контейнера
 ENV PORT=8000
 EXPOSE 8000

diff --git a/services/calc-service/Dockerfile b/services/calc-service/Dockerfile
index f97f71c..de328d4 100644
--- a/services/calc-service/Dockerfile
+++ b/services/calc-service/Dockerfile
@@ -10,6 +10,8 @@ RUN pip install --no-cache-dir -r requirements.txt

 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common
 # Стандартный порт внутри контейнера
 ENV PORT=8000
 EXPOSE 8000

diff --git a/services/embedding-api/Dockerfile b/services/embedding-api/Dockerfile
index 380bd86..aad2c38 100644
--- a/services/embedding-api/Dockerfile
+++ b/services/embedding-api/Dockerfile
@@ -9,6 +9,8 @@ RUN pip install --no-cache-dir -r requirements.txt

 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common
 EXPOSE 8000

 CMD ["sh", "-c", "uvicorn main:app --host 0.0.0.0 --port 8000"]

diff --git a/bot/Dockerfile b/bot/Dockerfile
index 9eacf85..f255dd9 100644
--- a/bot/Dockerfile
+++ b/bot/Dockerfile
@@ -11,5 +11,7 @@ RUN --mount=type=cache,target=/root/.cache/pip \

 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common

 CMD ["python","/app/main.py"]

diff --git a/services/goszakup-api/Dockerfile b/services/goszakup-api/Dockerfile
index aba09b9..0f8efec 100644
--- a/services/goszakup-api/Dockerfile
+++ b/services/goszakup-api/Dockerfile
@@ -8,6 +8,8 @@ FROM python:3.11-slim

 # Копирование кода
 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common

 EXPOSE 8001

diff --git a/services/doc-service/Dockerfile b/services/doc-service/Dockerfile
index f97f71c..de328d4 100644
--- a/services/doc-service/Dockerfile
+++ b/services/doc-service/Dockerfile
@@ -10,6 +10,8 @@ RUN pip install --но-cache-dir -r requirements.txt

 COPY . .
+# Копируем общую библиотеку из дополнительного контекста libs
+COPY --from=libs /zakupai_common /app/libs/zakupai_common
 # Стандартный порт внутри контейнера
 ENV PORT=8000
 EXPOSE 8000

--
2.42.0

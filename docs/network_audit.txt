ZakupAI Docker Network Audit Report
1. Networks Summary
Network	Driver	External	Exists on host	Attached services (definitions → runtime)	Status
zakupai-network (runtime name zakupai_zakupai-network) – defined in every core compose incl. docker-compose.yml (lines 481-490), stage7 override docker-compose.override.stage7.vault.yml (lines 330-336), workflows alias docker-compose.workflows.yml (lines 114-117)	bridge	false (workflows pins the existing one via name)	✅ docker network ls → zakupai_zakupai-network	92 services declared (db, vault, redis, grafana, prometheus, calc-service, risk-engine, embedding-api, exporters, etc.); currently 14 containers share it per docker inspect zakupai_zakupai-network	⚠️ Everything (DB, Redis, Vault, user-facing APIs) lives on the same bridge, so any compromise has lateral movement.
ai-network (docker-compose.yml (lines 481-484))	bridge	false	✅ zakupai_ai-network	Embedding API, risk-engine, doc-service, flowise, n8n; only zakupai-embedding-api & zakupai-risk-engine are actually attached right now (docker inspect zakupai_ai-network)	⚠️ Partial isolation. Flowise/n8n fall back to the core net when the workflows stack is up, limiting the value of this segment.
vault-net (docker-compose.yml (lines 485-487), override docker-compose.override.monitoring.yml (lines 99-103))	bridge	false	✅ zakupai_vault-net	Vault service only	⚠️ Vault is isolated but no monitoring or clients join this network, so it adds little beyond an extra interface on Vault.
monitoring-net (docker-compose.yml (lines 488-490), override docker-compose.override.monitoring.yml (lines 104-106))	bridge	false	✅ zakupai_monitoring-net	Prometheus/Grafana/Alertmanager are defined to join here, but runtime inspect shows only zakupai-vault; the monitoring stack still uses the core network	⚠️ Intended monitoring isolation is unused; traffic and secrets stay on the shared bridge.
backend (stage8/9 overrides docker-compose.override.stage8.vault-secure.yml (lines 53-77), docker-compose.override.stage9.vault-prod.yml (lines 67-104))	bridge	true	❌ no backend network present	Vault (Stage8/9)	❌ Deployments for Stage8/9 will fail unless this external network is pre-created or re-pointed to zakupai_zakupai-network, and Vault would otherwise be unreachable by the app stack.
monitoring (stage8/9 overrides docker-compose.override.stage8.vault-secure.yml (lines 53-76), docker-compose.override.stage9.vault-prod.yml (lines 67-104))	bridge	true	❌ missing	Vault (Stage8/9)	❌ Same issue as backend; TLS/monitoring path will not come up without creating/providing this network.
2. Port Bindings & Conflicts
Currently exposed (runtime docker ps) – open on 0.0.0.0: Postgres 5432 (zakupai-db), Redis 6379 (zakupai-redis), calc-service 7001, risk-engine 7002, doc-service 7003, billing-service 7004, goszakup 7005, etl-service 7011, embedding API 7010, Grafana 3030, Prometheus 9095, Alertmanager 9093, cadvisor 8081. Vault is not currently published (only 8200/tcp internally), so CLI/API must go through the network.
Static conflicts between compose files (simultaneous stacks would collide):
Host port	Compose files / services	Notes
5432	docker-compose.yml (db) vs docker-compose.bot-test.yml (postgres)	Bot-test stack cannot run beside production DB without changing ports.
6379	docker-compose.override.stage7.vault.yml (lines 69-75) (redis) & any local Redis already on host	Redis is wide open to LAN/IPv6; consider binding to 127.0.0.1.
7001-7011	Core microservices across base/backups share identical host ports; staging/backup compose files (docker-compose.backup.yml, docker-compose.fixed.yml) can’t run concurrently on the same host.	
8080/8082	Gateway/web-ui/adminer defined in multiple overrides (dev + prod) use identical bindings.	
8200	Every Vault definition (base + stage7-9 + monitoring override) exposes 8200, so only one Vault stack can run per host. Stage9 also adds 8201, which is unique today.	
3000 & 5678	Flowise/n8n appear both in the main stack and docker-compose.workflows.yml, so workflows overlap with prod if launched together.	
3. Volumes & Mount Paths
Base Vault mounts /vault/file and /vault/logs from vault_data / vault_logs (docker-compose.yml (lines 412-478)). Stage7 introduces different volume names (vault-data, vault-logs at docker-compose.override.stage7.vault.yml:37-45,330-335). Docker confirms all four volumes exist (docker volume ls → zakupai_vault_data, zakupai_vault_logs, zakupai_vault-data, zakupai_vault-logs), so data can fork when switching stages. Consider standardising on one name set and migrating data before pruning the unused pair.
/vault/creds and .unseal-password are bind-mounted in stage7+ overrides (e.g. docker-compose.override.stage7.yml (lines 17-44), docker-compose.override.stage8.vault-secure.yml (lines 33-48), docker-compose.override.stage9.vault-prod.yml (lines 44-60)). Ensure those host paths exist and have 100 (line 1000) ownership or Vault init scripts will fail.
Stage9 adds /vault/tls and /vault/plugins (lines 55-62 in the stage9 override) but intentionally omits /vault/data because the backend is S3; double-check that the S3 credentials are injected out-of-band before enabling the override.
4. Connectivity & Orphans
Core mesh – zakupai-network currently links DB, Redis, Vault, Grafana, Prometheus, Alertmanager, node-exporter, redis/postgres exporters, vault-metrics, and the customer-facing services (calc-service, risk-engine, embedding-api, etl-service). Dependencies (calc-service, risk-engine, etl-service) explicitly wait for Vault (docker-compose.yml (lines 67-169)), so ordering is handled but network isolation is not.
AI sidecar net – only zakupai-embedding-api and zakupai-risk-engine are actually attached to zakupai_ai-network; Flowise/n8n would join when their stacks run.
Vault-only nets – zakupai_vault-net and zakupai_monitoring-net contain only zakupai-vault, so Prometheus/Grafana/Alertmanager still scrape Vault over the shared network despite docker-compose.override.monitoring.yml (lines 52-85).
Stage8/9 overrides remove zakupai-network from Vault entirely (docker-compose.override.stage8.vault-secure.yml (lines 53-55), docker-compose.override.stage9.vault-prod.yml (lines 67-70)). Unless the missing backend network is an alias of zakupai-network, Vault will be isolated from every consumer.
Orphans – No running containers are detached from an existing network (docker ps --format '{{.Names}} -> {{.Networks}}' shows each one attached to at least one active zakupai_* network). Exporters like zakupai-vault-metrics, zakupai-redis-exporter, and zakupai-node-exporter ride the same shared bridge, so they are not orphaned but also not isolated.
5. Findings & Recommendations
❌ Missing external networks for Stage8/9 Vault – Create them up front (docker network create --driver bridge backend and docker network create --driver bridge monitoring) or, preferably, update the overrides to reuse the existing nets via name: zakupai_zakupai-network / name: zakupai_monitoring-net so Vault stays reachable. Without this, docker compose up for Stage9 will error immediately and even a forced start would strand Vault away from calc/risk/doc services.
❌ Stage8/9 connectivity gap – Because Vault is only on backend+monitoring, the rest of the stack on zakupai-network can’t reach it. Update the Stage8/9 overrides to either (1) add zakupai-network back to services.vault.networks, or (2) define backend with external: true + name: zakupai_zakupai-network.
⚠️ Monitoring isolation unused – Prometheus/Grafana/Alertmanager never join monitoring-net despite the override. Either start the stack with -f docker-compose.override.monitoring.yml or manually connect running containers (docker network connect zakupai_monitoring-net zakupai-prometheus etc.) so Vault metrics/tokens stay off the core bridge.
⚠️ Volume name divergence – Decide whether vault_data/vault_logs or vault-data/vault-logs should be canonical, migrate data accordingly, and remove the unused pair (docker stop zakupai-vault && docker volume rm zakupai_vault-data once confirmed). Keeping both risks running Vault against the wrong backend after a stage switch.
⚠️ Host-wide exposures – Postgres (docker-compose.yml (lines 13-22)), Redis (docker-compose.override.stage7.vault.yml (lines 69-85)), and every API port are bound to 0.0.0.0. Lock them down (127.0.0.1:PORT or remove the mapping and use docker compose port) or front them with the gateway to reduce attack surface.
⚠️ Duplicate network definitions – zakupai-network is declared in six files; consolidate the definition (e.g., keep it only in docker-compose.yml and drop it from overrides) to avoid config drift. Likewise, make the workflows compose reference the core definition instead of redefining it externally.
⚠️ Monitoring exporters on shared net – zakupai-redis-exporter, zakupai-postgres-exporter, and zakupai-vault-metrics only live on zakupai-network, so any compromise can reach Vault or DB credentials. Consider attaching them to a read-only monitoring bridge.
⚠️ Pruning guidance – Every zakupai_* network currently has active endpoints, so DO NOT run docker network prune yet. Revisit pruning after consolidating networks/volumes; when safe, docker network prune --filter name=zakupai_ can clean up leftovers.
Suggested next steps

Decide whether to create dedicated backend/monitoring networks or remap those names to the existing zakupai nets; update Stage8/9 overrides accordingly.
Re-run the monitoring stack with its override (or connect running containers) so monitoring-net actually carries monitoring traffic.
Standardise Vault volume names and migrate data, then remove unused volumes and update the stage7 override to match.
Tighten host port bindings (at minimum Postgres/Redis) and document that staging/bot-test compose files require alternate host ports before co-running.
After any topology change, verify with docker network inspect <net> and docker ps --format '{{.Names}} -> {{.Ports}}' that attachments/exposures match expectations.
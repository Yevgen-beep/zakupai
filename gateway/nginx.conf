events {}
http {
  map $http_x_request_id $reqid { default $http_x_request_id; "" $request_id; }
  log_format json escape=json '{ "time":"$time_iso8601","remote":"$remote_addr","method":"$request_method","uri":"$request_uri","status":$status,"req_id":"$reqid","rt":$request_time }';
  access_log /var/log/nginx/access.log json;

  # 60 запросов в минуту на IP
  limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
  limit_req_status 429;

  upstream calc { server zakupai-calc:8001; }
  upstream risk { server zakupai-risk:8002; }
  upstream doc  { server zakupai-doc:8003; }
  upstream emb  { server zakupai-emb:8004; }

  server {
    listen 80;

    # health — без лимитов
    location = /calc/health { proxy_pass http://calc/health; }
    location = /risk/health { proxy_pass http://risk/health; }
    location = /doc/health  { proxy_pass http://doc/health; }
    location = /emb/health  { proxy_pass http://emb/health; }

    # API — с лимитами
    location /calc/    { limit_req zone=api burst=20 nodelay; proxy_set_header X-Request-Id $reqid; proxy_pass http://calc; }
    location /risk/    { limit_req zone=api burst=20 nodelay; proxy_set_header X-Request-Id $reqid; proxy_pass http://risk; }
    location /tldr     { limit_req zone=api burst=10 nodelay; proxy_set_header X-Request-Id $reqid; proxy_pass http://doc; }
    location /letters/ { limit_req zone=api burst=10 nodelay; proxy_set_header X-Request-Id $reqid; proxy_pass http://doc; }
    location /render/  { limit_req zone=api burst=10 nodelay; proxy_set_header X-Request-Id $reqid; proxy_pass http://doc; }
    location /embed    { limit_req zone=api burst=30 nodelay; proxy_set_header X-Request-Id $reqid; proxy_pass http://emb; }
  }
}

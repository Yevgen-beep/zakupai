# Nginx Gateway –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è ZakupAI
# –û–±—Å–ª—É–∂–∏–≤–∞–µ—Ç API —Å–µ—Ä–≤–∏—Å—ã + React/FastAPI —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

events {
  worker_connections 1024;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
  map $http_x_request_id $reqid {
    default $http_x_request_id;
    "" $request_id;
  }

  # JSON –ª–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  log_format json escape=json
    '{ "time":"$time_iso8601", "remote":"$remote_addr", "method":"$request_method",'
    ' "uri":"$request_uri", "status":$status, "req_id":"$reqid", "rt":$request_time,'
    ' "upstream":"$upstream_addr", "size":$body_bytes_sent }';
  access_log /var/log/nginx/access.log json;

  # Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS
  limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;    # API —Å–µ—Ä–≤–∏—Å—ã
  limit_req_zone $binary_remote_addr zone=web:10m rate=200r/m;   # –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–≤—ã—à–µ –ª–∏–º–∏—Ç)
  limit_req_status 429;

  # –ö—ç—à –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (CSS, JS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
  proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=static:10m max_size=100m inactive=60m;

  # Gzip —Å–∂–∞—Ç–∏–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
  gzip on;
  gzip_vary on;
  gzip_min_length 1000;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/atom+xml
    image/svg+xml;

  # –û–±—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Nginx
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  client_max_body_size 10M;  # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

  # ===== –ê–ü–°–¢–†–ò–ú–´ =====
  # –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã API (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
  upstream calc { server zakupai-calc-service:8000; }
  upstream risk { server zakupai-risk-engine:8000; }
  upstream doc  { server zakupai-doc-service:8000; }
  upstream emb  { server zakupai-embedding-api:8000; }
  upstream etl  { server zakupai-etl-service:8000; }

  # –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (React + FastAPI)
  upstream web  { server zakupai-web:8000; }

  server {
    listen 80;
    server_name _;  # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–π Host header

    # ===== HEALTH CHECKS =====
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –±–µ–∑ rate limiting
    location = /calc/health { proxy_pass http://calc/health; }
    location = /risk/health { proxy_pass http://risk/health; }
    location = /doc/health  { proxy_pass http://doc/health; }
    location = /emb/health  { proxy_pass http://emb/health; }
    location = /etl/health  { proxy_pass http://etl/health; }
    location = /health      { proxy_pass http://web/health; }

    location /stub_status {
      stub_status;
      access_log off;
      allow 127.0.0.1;
      allow 172.18.0.0/16;
      deny all;
    }

    # ===== API –ú–ò–ö–†–û–°–ï–†–í–ò–°–´ =====
    # –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å (/calc/, /risk/ –∏ —Ç.–¥.) –ø–µ—Ä–µ–¥ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    location /calc/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/calc/?(.*)$ /$1 break;  # /calc/vat -> /vat
      proxy_pass http://calc;
    }
    location /risk/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/risk/?(.*)$ /$1 break;  # /risk/score -> /score
      proxy_pass http://risk;
    }
    location /doc/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/doc/?(.*)$ /$1 break;   # /doc/tldr -> /tldr
      proxy_pass http://doc;
    }
    location /emb/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/emb/?(.*)$ /$1 break;   # /emb/search -> /search
      proxy_pass http://emb;
    }
    location /etl/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/etl/?(.*)$ /$1 break;   # /etl/run -> /run
      proxy_pass http://etl;
    }

    # ===== –°–¢–ê–¢–ò–ß–ï–°–ö–ò–ï –§–ê–ô–õ–´ REACT =====
    # CSS, JS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —à—Ä–∏—Ñ—Ç—ã
    location /static/ {
      # –ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π rate limit –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
      limit_req zone=web burst=50 nodelay;

      # –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
      proxy_pass http://web;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-Id $reqid;

      # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
      proxy_cache static;
      proxy_cache_valid 200 1h;
      proxy_cache_bypass $http_pragma $http_authorization;
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
      add_header X-Cache-Status $upstream_cache_status;
      expires 1h;

      # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
      add_header Cache-Control "public, immutable";
    }

    # ===== API –ó–ê–ü–†–û–°–´ –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
    # FastAPI endpoints (/api/lot/123, /api/upload-prices –∏ —Ç.–¥.)
    location /api/ {
      limit_req zone=web burst=30 nodelay;

      # –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä proxy –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      proxy_pass http://web;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-Id $reqid;
      proxy_set_header Connection "";
      proxy_http_version 1.1;

      # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è API
      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;
      proxy_read_timeout 30s;
      proxy_connect_timeout 5s;
      proxy_send_timeout 30s;
    }

    # ===== –§–†–û–ù–¢–ï–ù–î –ú–ê–†–®–†–£–¢–´ =====
    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ: /, /attachments, /upload, /lot/123 –∏ —Ç.–¥.
    # –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è React SPA
    location / {
      limit_req zone=web burst=50 nodelay;

      # –ü–µ—Ä–µ–¥–∞—á–∞ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã FastAPI
      proxy_pass http://web;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-Id $reqid;
      proxy_set_header Connection "";
      proxy_http_version 1.1;

      # –í–ê–ñ–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è HTML
      # React SPA –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π index.html –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
      proxy_cache off;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";

      # –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ç–∞–π–º–∞—É—Ç—ã
      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;
      proxy_read_timeout 30s;
      proxy_connect_timeout 5s;
      proxy_send_timeout 30s;

      # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ upstream
      proxy_intercept_errors on;
      error_page 404 = @spa_fallback;     # React Router fallback
      error_page 502 503 504 = @maintenance;
    }

    # ===== SPA FALLBACK =====
    # –ï—Å–ª–∏ backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404, –ø—Ä–æ–±—É–µ–º –æ—Ç–¥–∞—Ç—å React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    # –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è client-side routing (/attachments, /suppliers –∏ —Ç.–¥.)
    location @spa_fallback {
      proxy_pass http://web/;  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-Id $reqid;

      # –ë–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }

    # ===== –°–¢–†–ê–ù–ò–¶–ê –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø =====
    # –ö–æ–≥–¥–∞ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502, 503, 504)
    location @maintenance {
      return 503 '<!DOCTYPE html>
      <html><head><title>ZakupAI - –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</title></head>
      <body style="font-family: sans-serif; text-align: center; padding: 50px;">
        <h1>üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
        <p>–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
      </body></html>';
      add_header Content-Type "text/html; charset=utf-8";
    }
  }
}

events {}

http {
  # X-Request-Id
  map $http_x_request_id $reqid { default $http_x_request_id; "" $request_id; }

  # Логи
  log_format json escape=json
    '{ "time":"$time_iso8601", "remote":"$remote_addr", "method":"$request_method",'
    ' "uri":"$request_uri", "status":$status, "req_id":"$reqid", "rt":$request_time }';
  access_log /var/log/nginx/access.log json;

  # Рейт-лимиты
  limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
  limit_req_status 429;

  # Апстримы — фактические внутриконтейнерные порты
  upstream calc { server zakupai-calc:8001; }
  upstream risk { server zakupai-risk:8000; }
  upstream doc  { server zakupai-doc:8003; }
  upstream emb  { server zakupai-emb:8000; }

  server {
    listen 80;

    # health без лимитов
    location = /calc/health { proxy_pass http://calc/health; }
    location = /risk/health { proxy_pass http://risk/health; }
    location = /doc/health  { proxy_pass http://doc/health; }
    location = /emb/health  { proxy_pass http://emb/health; }

    # API с лимитами
    location /calc/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/calc/?(.*)$ /$1 break;
      proxy_pass http://calc;
    }
    location /risk/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/risk/?(.*)$ /$1 break;
      proxy_pass http://risk;
    }
    location /doc/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/doc/?(.*)$ /$1 break;
      proxy_pass http://doc;
    }
    location /emb/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      rewrite ^/emb/?(.*)$ /$1 break;
      proxy_pass http://emb;
    }
  }
}

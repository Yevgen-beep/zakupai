events {}

http {
  # X-Request-Id
  map $http_x_request_id $reqid { default $http_x_request_id; "" $request_id; }

  # Logs
  log_format json escape=json
    '{ "time":"$time_iso8601", "remote":"$remote_addr", "method":"$request_method",'
    ' "uri":"$request_uri", "status":$status, "req_id":"$reqid", "rt":$request_time }';
  access_log /var/log/nginx/access.log json;

  # Rate limits (strict for production)
  limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
  limit_req_status 429;

  # Upstreams
  upstream calc { server zakupai-calc-service:8000; }
  upstream risk { server zakupai-risk-engine:8000; }
  upstream doc  { server zakupai-doc-service:8000; }
  upstream emb  { server zakupai-embedding-api:8000; }

  server {
    listen 80;
    listen 443 ssl http2;

    # SSL configuration
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # CORS for production (strict origins)
    set $cors_origin "";
    if ($http_origin ~* "^https://(zakupai\.exomind\.site|n8n\.exomind\.site)$") {
      set $cors_origin $http_origin;
    }

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-API-Key" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # Strict security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://zakupai.exomind.site https://n8n.exomind.site; frame-ancestors 'none';" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()" always;

    # Redirect HTTP to HTTPS
    if ($scheme != "https") {
      return 301 https://$host$request_uri;
    }

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
      return 204;
    }

    # Health endpoints (no rate limiting)
    location = /calc/health { proxy_pass http://calc/health; }
    location = /risk/health { proxy_pass http://risk/health; }
    location = /doc/health  { proxy_pass http://doc/health; }
    location = /emb/health  { proxy_pass http://emb/health; }

    # API endpoints with strict rate limiting
    location /calc/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $host;
      rewrite ^/calc/?(.*)$ /$1 break;
      proxy_pass http://calc;
    }

    location /risk/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $host;
      rewrite ^/risk/?(.*)$ /$1 break;
      proxy_pass http://risk;
    }

    location /doc/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_Set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $host;
      rewrite ^/doc/?(.*)$ /$1 break;
      proxy_pass http://doc;
    }

    location /emb/ {
      limit_req zone=api burst=10 nodelay;
      proxy_set_header X-Request-Id $reqid;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $host;
      rewrite ^/emb/?(.*)$ /$1 break;
      proxy_pass http://emb;
    }
  }
}

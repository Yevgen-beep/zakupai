worker_processes auto;
error_log /var/log/nginx/error.log warn;

events { worker_connections 1024; }

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - [$time_local] "$request" $status $body_bytes_sent';

    access_log /var/log/nginx/access.log main;

    sendfile on;

    # === Rate limit ===
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_status 429;

    # === Upstreams ===
    upstream gateway_backend      { server gateway-backend:8000; }
    upstream vault_backend        { server vault:8200; }

    upstream calc_backend         { server calc-service:8000; }
    upstream risk_backend         { server risk-engine:8000; }
    upstream etl_backend          { server etl-service:8000; }
    upstream billing_backend      { server billing-service:8000; }
    upstream doc_backend          { server doc-service:8000; }
    upstream embedding_backend    { server embedding-api:8000; }
    upstream web_backend          { server web-ui:8000; }

    server {
        listen 80;

        location /health { proxy_pass http://gateway_backend/health; }

        location /vault/health {
            proxy_pass https://vault_backend/v1/sys/health?standbyok=true;
            proxy_ssl_verify off;
        }

        location /metrics { proxy_pass http://gateway_backend/metrics; }

        location /calc/      { limit_req zone=api_limit burst=20; proxy_pass http://calc_backend/; }
        location /risk/      { limit_req zone=api_limit burst=20; proxy_pass http://risk_backend/; }
        location /etl/       { limit_req zone=api_limit burst=20; proxy_pass http://etl_backend/; }
        location /billing/   { limit_req zone=api_limit burst=20; proxy_pass http://billing_backend/; }
        location /doc/       { limit_req zone=api_limit burst=20; proxy_pass http://doc_backend/; }
        location /emb/       { limit_req zone=api_limit burst=20; proxy_pass http://embedding_backend/; }
        location /web/       { limit_req zone=api_limit burst=20; proxy_pass http://web_backend/; }
    }
}

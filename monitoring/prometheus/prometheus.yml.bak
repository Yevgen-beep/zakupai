global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - /etc/prometheus/alerts.yml
  - /etc/prometheus/rules.yml

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets: ['prometheus:9095']

  - job_name: blackbox-http
    scrape_interval: 30s
    scrape_timeout: 10s
    metrics_path: /probe
    static_configs:
      - targets:
          - 'http://gateway:80/health'
          - 'https://ows.goszakup.gov.kz/v3/ru/ping'
        labels:
          env: stage6
    params:
      module: [http_2xx]
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - source_labels: [__param_target]
        target_label: target

  - job_name: node-exporter
    static_configs:
      - targets: ['node-exporter-stage6:9100']
        labels:
          env: stage6

  - job_name: cadvisor
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          env: stage6

  # ZakupAI microservices (FastAPI /metrics)
  - job_name: calc-service
    metrics_path: /metrics
    static_configs:
      - targets: ['calc-service:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: calc

  - job_name: risk-engine
    metrics_path: /metrics
    static_configs:
      - targets: ['risk-engine:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: risk

  - job_name: doc-service
    metrics_path: /metrics
    static_configs:
      - targets: ['doc-service:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: doc

  - job_name: embedding-api
    metrics_path: /metrics
    static_configs:
      - targets: ['embedding-api:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: embedding

  - job_name: etl-service
    metrics_path: /metrics
    static_configs:
      - targets: ['etl-service:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: etl

  - job_name: web-ui
    metrics_path: /metrics
    static_configs:
      - targets: ['web-ui:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: web-ui

  - job_name: goszakup-api
    metrics_path: /metrics
    static_configs:
      - targets: ['goszakup-api:8001']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: goszakup

  - job_name: billing-service
    metrics_path: /metrics
    static_configs:
      - targets: ['billing-service:8000']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: billing

  - job_name: zakupai-bot
    metrics_path: /metrics
    static_configs:
      - targets: ['zakupai-bot:8081']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: bot

  - job_name: gateway
    metrics_path: /metrics
    static_configs:
      - targets: ['gateway:80']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: gateway

  - job_name: nginx
    static_configs:
      - targets: ['nginx-exporter:9113']
        labels:
          env: stage6
    relabel_configs:
      - target_label: service
        replacement: nginx-exporter

  # Vault metrics temporarily disabled (requires VAULT_TOKEN provisioning)
  # - job_name: vault
  #   metrics_path: /v1/sys/metrics
  #   params:
  #     format: ['prometheus']
  #   scheme: https
  #   static_configs:
  #     - targets: ['vault:8200']
  #   tls_config:
  #     insecure_skip_verify: true
  #   authorization:
  #     type: Bearer
  #     credentials_file: /etc/prometheus/vault-metrics.token
